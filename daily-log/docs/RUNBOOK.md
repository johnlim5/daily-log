# Daily Log 障害対応マニュアル（Runbook）

障害発生時の対応手順書です。

---

## 障害対応フロー

```
[障害検知]
    │
    ▼
[影響範囲の特定] ──→ 全体停止？ / 一部機能？
    │
    ▼
[原因の切り分け] ──→ フロントエンド / Worker / 外部API
    │
    ▼
[対応実施]
    │
    ▼
[復旧確認]
    │
    ▼
[事後報告・再発防止]
```

---

## 障害パターン別対応

### 1. アプリにアクセスできない

**症状:**
- ページが表示されない
- 「404 Not Found」が表示される

**切り分け:**
```
□ GitHub Pages のステータス確認
  → https://www.githubstatus.com/

□ ブラウザのキャッシュクリアして再試行

□ 別のネットワーク（スマホのテザリング等）で確認
```

**対応:**
| 原因 | 対応 |
|------|------|
| GitHub Pages 障害 | GitHub の復旧を待つ |
| デプロイ失敗 | `npm run deploy` を再実行 |
| base URL 設定ミス | vite.config.ts の `base` を確認して再デプロイ |

---

### 2. ログインできない

**症状:**
- パスワードを入力しても「ログイン」後に何も起きない
- エラーメッセージなし

**切り分け:**
```
□ ブラウザの開発者ツール → Network タブで /data リクエストを確認
  → ステータスコードは？

□ Console にエラーが出ていないか確認
```

**対応:**
| ステータス | 原因 | 対応 |
|------------|------|------|
| 401 | パスワード間違い | 正しいパスワードを確認 |
| 500 | Worker 内部エラー | Worker のログを確認 |
| ネットワークエラー | Worker 停止 or CORS | Worker の設定を確認 |

**Worker ログの確認方法:**
1. Cloudflare ダッシュボード → Workers & Pages
2. `my-gemini-worker` を選択
3. 「Logs」タブでリアルタイムログを確認

---

### 3. データが保存されない

**症状:**
- 習慣をチェックしても、ページ更新で消える
- 新しい習慣を追加しても保存されない

**切り分け:**
```
□ Network タブで POST /data のレスポンスを確認

□ Worker のログでエラーを確認

□ KV の容量制限に達していないか確認
```

**対応:**
| 原因 | 対応 |
|------|------|
| Worker エラー | ログを見て修正 |
| KV 書き込み失敗 | KV バインディングを確認 |
| データ形式エラー | 送信データの JSON を確認 |

---

### 4. AI分析が動かない

**症状:**
- 「AI分析を実行」ボタンを押しても結果が出ない
- 「通信エラー」と表示される

**切り分け:**
```
□ Network タブで POST /gemini のレスポンスを確認

□ Gemini API の利用制限に達していないか確認
  → https://console.cloud.google.com/

□ Worker のログを確認
```

**対応:**
| 原因 | 対応 |
|------|------|
| API キー無効 | 新しいキーを発行して Worker に設定 |
| レート制限 | しばらく待つ、または有料プランへ |
| Worker タイムアウト | プロンプトを短くする |

**Gemini API キー再発行手順:**
1. [Google AI Studio](https://ai.google.dev/) にアクセス
2. 「Get API Key」→ 新しいキーを作成
3. Cloudflare Worker の環境変数 `GEMINI_API_KEY` を更新
4. Worker を再デプロイ

---

### 5. グラフが表示されない

**症状:**
- 分析タブでグラフエリアが空白

**切り分け:**
```
□ 分析対象の習慣が選択されているか確認

□ 選択した期間内にログがあるか確認

□ Console にエラーがないか確認
```

**対応:**
| 原因 | 対応 |
|------|------|
| 習慣未選択 | 習慣ボタンをタップして選択 |
| データなし | 期間を広げる、または記録を追加 |
| Recharts エラー | ブラウザを更新、または別ブラウザで確認 |

---

### 6. 表示が崩れる

**症状:**
- レイアウトが崩れている
- スタイルが適用されていない

**切り分け:**
```
□ Tailwind CSS CDN が読み込まれているか確認
  → Network タブで cdn.tailwindcss.com を確認

□ 特定のブラウザだけで発生するか確認
```

**対応:**
| 原因 | 対応 |
|------|------|
| CDN 障害 | CDN の復旧を待つ |
| ブラウザ互換性 | 対応ブラウザで利用するよう案内 |
| キャッシュ | スーパーリロード（Ctrl+Shift+R） |

---

## 緊急連絡先

| 状況 | 連絡先 |
|------|--------|
| GitHub 障害 | https://www.githubstatus.com/ |
| Cloudflare 障害 | https://www.cloudflarestatus.com/ |
| Google API 障害 | https://status.cloud.google.com/ |

---

## 復旧確認チェックリスト

障害対応後、以下を確認：

```
□ トップページにアクセスできる
□ ログインできる
□ 習慣一覧が表示される
□ 習慣をチェックして保存される
□ ページ更新後もデータが残っている
□ 履歴タブにログが表示される
□ AI分析が実行できる
□ モバイル表示が正常
```

---

## 事後報告テンプレート

```markdown
## 障害報告

### 概要
- 発生日時: YYYY-MM-DD HH:MM ～ HH:MM
- 影響範囲:
- 影響ユーザー数:

### 経緯
1. HH:MM 〇〇が発生
2. HH:MM △△を実施
3. HH:MM 復旧確認

### 原因
（根本原因を記載）

### 対応内容
（実施した対応を記載）

### 再発防止策
（今後の対策を記載）
```

---

## 定期メンテナンス項目

### 月次
- [ ] Cloudflare Worker のログ確認（エラー傾向）
- [ ] KV のデータサイズ確認
- [ ] 依存パッケージの脆弱性チェック（`npm audit`）

### 四半期
- [ ] 依存パッケージのアップデート
- [ ] API キーのローテーション検討
- [ ] バックアップからの復元テスト
